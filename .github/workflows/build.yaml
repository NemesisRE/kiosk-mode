name: Build and Release
permissions:
  contents: read

on:
  push:
    branches:
      - master
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-beta'
      - 'v[0-9]+.[0-9]+.[0-9]+-beta.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-alpha'
      - 'v[0-9]+.[0-9]+.[0-9]+-alpha.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-rc'
      - 'v[0-9]+.[0-9]+.[0-9]+-rc.[0-9]+'

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check Event Type
        id: check-event
        run: |
          if [[ ${{ github.ref_type }} == "tag" ]]; then
            echo "EVENT_TYPE=tag" >> $GITHUB_OUTPUT
            if [[ ${{ github.event.ref }} =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+-.+([0-9]+)?$ ]]; then
              echo "PRERELEASE=true" >> $GITHUB_OUTPUT
            else
              echo "PRERELEASE=false" >> $GITHUB_OUTPUT
            fi
            echo "TARGET_COMMITISH=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "EVENT_TYPE=push" >> $GITHUB_OUTPUT
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "TARGET_COMMITISH=${{ github.event.repository.default_branch }}" >> $GITHUB_OUTPUT
          fi
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false
      - name: Set-up Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Install deps
        run: pnpm install
      - name: E2E tests
        run: pnpm test:all
      - name: Create coverage
        run: pnpm coverage:report
      - uses: actions/upload-artifact@v5
        if: always()
        with:
          name: test-report
          path: |
            playwright-report/
            coverage/
          retention-days: 30
      - name: Update draft release
        if: steps.check-event.outputs.EVENT_TYPE == 'push'
        uses: release-drafter/release-drafter@v6
        with:
          config-name: release-drafter.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create tagged release
        if: steps.check-event.outputs.EVENT_TYPE == 'tag'
        uses: release-drafter/release-drafter@v6
        with:
          config-name: release-drafter.yml
          publish: true
          tag: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          prerelease: ${{ steps.check-event.outputs.PRERELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload release assets
        if: steps.check-event.outputs.EVENT_TYPE == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/kiosk-mode.js